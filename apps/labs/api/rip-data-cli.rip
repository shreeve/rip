# ðŸ”¥ RipData CLI - Interactive REPL for DuckDB
# Connect to your revolutionary data server or direct file access

import { RipDataClient } from '@rip/data'
import { Database } from 'duckdb'

# Parse command line arguments
args = process.argv.slice(2)
mode = args[0] || 'server'

if mode == 'server'
  console.log 'ðŸ”¥ RipData CLI - Server Mode'
  console.log 'Connecting to http://localhost:8306...'

  client = new RipDataClient 'http://localhost:8306'

  # Test connection
  try
    health = client.health!
    console.log 'âœ… Connected successfully!'
    console.log 'ðŸ“Š Server status:', health.status
  catch error
    console.log 'âŒ Connection failed:', error.message
    console.log 'ðŸ’¡ Make sure rip-data-server is running: bun run data:start'
    process.exit(1)

  console.log ''
  console.log 'ðŸŽ¯ Interactive RipData REPL'
  console.log 'Type SQL queries and press Enter. Type .exit to quit.'
  console.log 'Examples:'
  console.log '  SELECT COUNT(*) FROM users;'
  console.log '  SELECT * FROM orders ORDER BY createdAt DESC LIMIT 5;'
  console.log '  .tables'
  console.log '  .schema users'
  console.log ''

  # Simple REPL loop
  readline = require 'readline'
  rl = readline.createInterface
    input: process.stdin
    output: process.stdout
    prompt: 'ripdata> '

  rl.prompt()

  rl.on 'line', (input) ->
    query = input.trim()

    if query == '.exit'
      console.log 'ðŸ‘‹ Goodbye!'
      process.exit(0)

    if query == '.tables'
      query = "SELECT table_name FROM information_schema.tables WHERE table_schema = 'main'"

    if query.startsWith('.schema ')
      tableName = query.split(' ')[1]
      query = "DESCRIBE #{tableName}"

    if query == ''
      rl.prompt()
      return

    try
      if query.toLowerCase().startsWith('select') or query.toLowerCase().startsWith('with') or query.toLowerCase().startsWith('describe') or query.includes('information_schema')
        # Read query
        result = client.query! query

        if result.length == 0
          console.log '(no rows)'
        else
          console.table result
      else
        # Write query
        result = client.execute! query
        console.log "âœ… Query executed successfully"
        if result.length > 0
          console.table result
    catch error
      console.log 'âŒ Error:', error.message

    rl.prompt()

  rl.on 'close', ->
    console.log 'ðŸ‘‹ Goodbye!'
    process.exit(0)

else if mode == 'direct'
  console.log 'ðŸ”¥ RipData CLI - Direct File Mode'
  dbPath = args[1] || './db/labs.duckdb'
  console.log "Connecting to #{dbPath}..."

  try
    db = new Database dbPath
    conn = db.connect()
    console.log 'âœ… Connected successfully!'
  catch error
    console.log 'âŒ Connection failed:', error.message
    process.exit(1)

  console.log ''
  console.log 'ðŸŽ¯ Interactive DuckDB REPL (Direct File Access)'
  console.log 'Type SQL queries and press Enter. Type .exit to quit.'
  console.log ''

  readline = require 'readline'
  rl = readline.createInterface
    input: process.stdin
    output: process.stdout
    prompt: 'duckdb> '

  rl.prompt()

  rl.on 'line', (input) ->
    query = input.trim()

    if query == '.exit'
      conn.close()
      db.close()
      console.log 'ðŸ‘‹ Goodbye!'
      process.exit(0)

    if query == '.tables'
      query = "SHOW TABLES"

    if query.startsWith('.schema ')
      tableName = query.split(' ')[1]
      query = "DESCRIBE #{tableName}"

    if query == ''
      rl.prompt()
      return

    try
      conn.all query, (err, result) ->
        if err
          console.log 'âŒ Error:', err.message
        else
          if result.length == 0
            console.log '(no rows)'
          else
            console.table result
        rl.prompt()
    catch error
      console.log 'âŒ Error:', error.message
      rl.prompt()

  rl.on 'close', ->
    conn.close()
    db.close()
    console.log 'ðŸ‘‹ Goodbye!'
    process.exit(0)

else
  console.log 'ðŸ”¥ RipData CLI - Revolutionary DuckDB Interface'
  console.log ''
  console.log 'Usage:'
  console.log '  bun rip-data-cli.rip server              # Connect to rip-data-server (default)'
  console.log '  bun rip-data-cli.rip direct              # Direct file access'
  console.log '  bun rip-data-cli.rip direct /path/to.db  # Direct file access with custom path'
  console.log ''
  console.log 'Examples:'
  console.log '  bun rip-data-cli.rip                     # Interactive server REPL'
  console.log '  bun rip-data-cli.rip direct              # Interactive file REPL'
  console.log ''
  console.log 'ðŸŽ¯ Available commands in REPL:'
  console.log '  .tables      - List all tables'
  console.log '  .schema NAME - Show table schema'
  console.log '  .exit        - Exit REPL'
  console.log ''
  console.log 'ðŸ”¥ Connect with any SQL query!'
  process.exit(0)