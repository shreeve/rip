#!/bin/bash

# üöÄ RIP Server Global Wrapper
# Location-independent wrapper for the RIP Application Server
# Add this to your PATH for global access

# Find the rip-server installation directory (script is now IN the server directory)
RIP_SERVER_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"

# If readlink -f doesn't work (macOS), use alternative
if [ ! -f "$RIP_SERVER_DIR/start.sh" ]; then
    # For macOS and systems without readlink -f
    SOURCE="${BASH_SOURCE[0]}"
    while [ -h "$SOURCE" ]; do
        DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
        SOURCE="$(readlink "$SOURCE")"
        [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
    done
    RIP_SERVER_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
fi

# Check if server files exist
if [ ! -f "$RIP_SERVER_DIR/start.sh" ]; then
    echo "‚ùå RIP Server components not found at: $RIP_SERVER_DIR"
    echo "üí° Make sure this script is in the server directory with start.sh, stop.sh, etc."
    exit 1
fi

# Execute the appropriate command
case "${1:-help}" in
    "start"|"dev"|"prod")
        exec "$RIP_SERVER_DIR/start.sh" "$@"
        ;;
    "stop")
        exec "$RIP_SERVER_DIR/stop.sh"
        ;;
    "test")
        exec "$RIP_SERVER_DIR/test.sh"
        ;;
    "help"|"-h"|"--help")
        echo "üöÄ RIP Application Server - Global Wrapper"
        echo ""
        echo "Usage:"
        echo "  rip-server start [mode] [foreground] [app_dir] [https_port] [cert_path] [key_path]"
        echo "  rip-server dev   [foreground] [app_dir] [https_port] [cert_path] [key_path]"
        echo "  rip-server prod  [foreground] [app_dir] [https_port] [cert_path] [key_path]"
        echo "  rip-server stop"
        echo "  rip-server test"
        echo ""
        echo "Examples:"
        echo "  rip-server dev                           # Start development server (HTTP only)"
        echo "  rip-server start dev false ./api        # Development, background, custom app"
        echo "  rip-server prod false ./api 3443 cert.pem key.pem  # Production with HTTPS"
        echo "  rip-server stop                          # Stop the server"
        echo "  rip-server test                          # Run test suite"
        echo ""
        echo "üî• Hot reload, multi-process architecture, HTTPS by default!"
        ;;
    *)
        # Default to start command for convenience
        exec "$RIP_SERVER_DIR/start.sh" "$@"
        ;;
esac