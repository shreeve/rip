<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rip Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50" x-data="dashboard()">
  <!-- Header -->
  <div class="border-b border-white/20 bg-white/30 backdrop-blur-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-[0_15px_30px_-8px_rgba(0,0,0,0.2)] border border-gray-100 transition-all duration-300 ease-in-out hover:scale-110 hover:shadow-[0_25px_50px_-12px_rgba(0,0,0,0.45)] cursor-pointer">
            <svg width="220" height="220" viewBox="0 0 220 220" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-9 h-9">
              <path d="M55.6822 169.86L41.8222 175.88L1.64219 109.8L41.8222 43.72L55.6822 49.74L19.1422 109.8L55.6822 169.86ZM164.318 169.86L200.858 109.8L164.318 49.74L178.178 43.72L218.358 109.8L178.178 175.88L164.318 169.86Z" fill="black"/>
              <path d="M69.8047 163V61.1818H113.754C121.31 61.1818 127.923 62.5573 133.59 65.3082C139.258 68.0592 143.666 72.0199 146.815 77.1903C149.963 82.3608 151.538 88.5587 151.538 95.7841C151.538 103.076 149.914 109.224 146.665 114.229C143.451 119.233 138.926 123.012 133.093 125.564C127.293 128.116 120.515 129.392 112.759 129.392H86.5092V107.915H107.191C110.439 107.915 113.207 107.517 115.494 106.722C117.814 105.893 119.587 104.584 120.813 102.794C122.073 101.004 122.702 98.6676 122.702 95.7841C122.702 92.8674 122.073 90.4976 120.813 88.6747C119.587 86.8187 117.814 85.4598 115.494 84.598C113.207 83.7031 110.439 83.2557 107.191 83.2557H97.4467V163H69.8047ZM129.464 116.267L154.918 163H124.89L100.032 116.267H129.464Z" fill="#BB0000"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Rip Server</h1>
            <p class="text-sm text-gray-600">Multi-worker runtime</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow"></div>
            <span class="text-sm font-medium text-gray-700" x-text="status.status || 'connecting...'">Loading...</span>
          </div>
          <button @click="refreshData()" class="p-2 text-gray-500 hover:text-gray-700 transition-colors">
            <svg class="w-5 h-5" :class="{'animate-spin': loading}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Server Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Status Card -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Server Status</p>
            <p class="text-2xl font-bold" x-text="!connected ? 'OFFLINE' : (status.status || 'loading...')"
               :class="!connected ? 'text-red-600' : (status.status === 'healthy' ? 'text-green-600' : 'text-yellow-600')">-</p>
          </div>
          <div class="p-3 rounded-full" :class="!connected ? 'bg-red-100' : (status.status === 'healthy' ? 'bg-green-100' : 'bg-yellow-100')">
            <svg class="w-6 h-6" :class="!connected ? 'text-red-600' : (status.status === 'healthy' ? 'text-green-600' : 'text-yellow-600')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    :d="!connected ? 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.732 15.5c-.77.833.192 2.5 1.732 2.5z' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Workers Card -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Active Workers</p>
            <p class="text-2xl font-bold text-blue-600" x-text="status.workers || '0'">-</p>
          </div>
          <div class="p-3 bg-blue-100 rounded-full">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Uptime Card with Countdown Arc -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Uptime</p>
            <p class="text-2xl font-bold text-purple-600" x-text="formatUptime(serverUptime)">-</p>
          </div>
          <div class="p-3 bg-purple-100 rounded-full relative">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Pure CSS Animated Countdown Arc -->
            <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 32 32">
              <!-- Background circle (light) -->
              <circle
                cx="16" cy="16" r="14"
                fill="none"
                stroke="rgb(196 181 253)"
                stroke-width="4"
                opacity="0.3"
              />
              <!-- Animated growing arc -->
              <circle
                cx="16" cy="16" r="14"
                fill="none"
                stroke-width="4"
                stroke-linecap="round"
                stroke-dasharray="87.96"
                stroke-dashoffset="87.96"
                :class="connected ? 'countdown-arc' : 'countdown-arc countdown-arc-paused'"
              />
            </svg>
                                    <style>
              .countdown-arc {
                animation: countdown-progress 10s linear infinite;
              }
              .countdown-arc-paused {
                animation-play-state: paused;
                opacity: 0.3;
              }

              @keyframes countdown-progress {
                0% {
                  stroke-dashoffset: 87.96;
                  stroke: rgb(139 92 246); /* Dark purple at start */
                }
                50% {
                  stroke-dashoffset: 44;
                  stroke: rgb(167 139 250); /* Medium purple halfway */
                }
                                100% {
                  stroke-dashoffset: 0;
                  stroke: rgb(196 181 253); /* Same as face - invisible blend */
                  opacity: 0.3; /* Same opacity as background face */
                }
              }
            </style>
          </div>
        </div>
      </div>

      <!-- App Card -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Current App</p>
            <p class="text-2xl font-bold text-indigo-600" x-text="status.app || 'none'">-</p>
          </div>
          <div class="p-3 bg-indigo-100 rounded-full">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Apps and Hosts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Active Hosts -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-white/20">
        <div class="p-6 border-b border-gray-200/50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
            </svg>
            Active Hosts
          </h2>
        </div>
        <div class="p-6">
          <div class="space-y-3" x-show="status.hosts && status.hosts.length > 0">
            <template x-for="host in status.hosts" :key="host">
              <div class="flex items-center justify-between p-3 bg-gray-50/50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span class="font-medium text-gray-900" x-text="host"></span>
                </div>
                <div class="flex items-center space-x-2">
                  <template x-if="host.endsWith('.local')">
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">mDNS</span>
                  </template>
                  <template x-if="host === 'localhost' || host === '127.0.0.1'">
                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Local</span>
                  </template>
                  <a :href="getHostUrl(host)" target="_blank" class="p-1 text-blue-600 hover:text-blue-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </a>
                </div>
              </div>
            </template>
          </div>
          <div x-show="!status.hosts || status.hosts.length === 0" class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
            </svg>
            <p>No hosts registered</p>
          </div>
        </div>
      </div>

      <!-- Server Ports -->
      <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-white/20">
        <div class="p-6 border-b border-gray-200/50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
            </svg>
            Server Ports
          </h2>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <template x-if="status.ports?.https">
              <div class="flex items-center justify-between p-3 bg-green-50/50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">HTTPS</p>
                    <p class="text-sm text-gray-600" x-text="`Port ${status.ports.https}`">-</p>
                  </div>
                </div>
                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Secure</span>
              </div>
            </template>
            <template x-if="status.ports?.http">
              <div class="flex items-center justify-between p-3 bg-blue-50/50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">HTTP</p>
                    <p class="text-sm text-gray-600" x-text="`Port ${status.ports.http} (→ HTTPS)`">-</p>
                  </div>
                </div>
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Redirect</span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-white/20">
      <div class="p-6 border-b border-gray-200/50">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Quick Actions
        </h2>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button @click="refreshData()" :disabled="loading" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" style="transition: opacity 0.3s ease;">
            <svg class="w-5 h-5 mr-2" :class="{'animate-spin': loading}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span x-text="loading ? 'Refreshing...' : 'Refresh Data'"></span>
          </button>
          <a href="/server" target="_blank" class="flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Health Check
          </a>
          <a href="https://github.com/shreeve/rip" target="_blank" class="flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Documentation
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="border-t border-white/20 bg-white/30 backdrop-blur-sm mt-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <p class="text-sm text-gray-600">
            Built with ❤️ for the <strong>Rip</strong> community
          </p>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-xs text-gray-500" x-text="'Updated ' + lastUpdated.toLocaleTimeString()">-</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    function dashboard() {
      return {
        status: {},
        loading: false,
        connected: true,
        serverUptime: 0,
        uptimeStartTime: Date.now(),
        lastUpdated: new Date(),

        async init() {
          await this.refreshData()
          // Auto-refresh every 10 seconds (silent - no loading indicator)
          setInterval(() => this.silentRefresh(), 10000)
          // Update uptime every second
          setInterval(() => this.updateLiveUptime(), 1000)
        },

        // Manual refresh with loading indicator (for button clicks)
        async refreshData() {
          this.loading = true
          try {
            await this.fetchStatus()
          } finally {
            this.loading = false
          }
        },

        // Silent background refresh (no loading indicator)
        async silentRefresh() {
          try {
            await this.fetchStatus()
            // this.connected is already set in fetchStatus() on success
          } catch (error) {
            // Mark as disconnected and update status
            this.connected = false
            this.status = {
              status: 'offline',
              app: this.status.app || 'unknown',
              workers: 0,
              uptime: 0,
              hosts: this.status.hosts || []
            }
            console.debug('Background refresh failed:', error)
          }
        },

        // Update live uptime counter
        updateLiveUptime() {
          // Only update uptime if connected
          if (this.connected) {
            const elapsedSeconds = Math.floor((Date.now() - this.uptimeStartTime) / 1000)
            this.serverUptime = (this.status.uptime || 0) + elapsedSeconds
          }
        },

        // Shared fetch logic
        async fetchStatus() {
          const response = await fetch('/status')
          if (response.ok) {
            this.status = await response.json()
            this.connected = true
            // Sync our local uptime tracking with server uptime
            this.serverUptime = this.status.uptime || 0
            this.uptimeStartTime = Date.now()
            // Update timestamp when data is successfully refreshed
            this.lastUpdated = new Date()
          } else {
            console.error('Failed to fetch status:', response.status)
            throw new Error(`HTTP ${response.status}`)
          }
        },

        formatUptime(seconds) {
          if (!seconds) return '0s'
          const hours = Math.floor(seconds / 3600)
          const minutes = Math.floor((seconds % 3600) / 60)
          const secs = seconds % 60

          if (hours > 0) return `${hours}h ${minutes}m`
          if (minutes > 0) return `${minutes}m ${secs}s`
          return `${secs}s`
        },

        getHostUrl(host) {
          // Determine protocol - prefer HTTPS if available
          const protocol = this.status.ports?.https ? 'https' : 'http'
          const port = this.status.ports?.https || this.status.ports?.http || 80

          // For standard ports, don't show port number
          if ((protocol === 'https' && port === 443) || (protocol === 'http' && port === 80)) {
            return `${protocol}://${host}`
          }
          return `${protocol}://${host}:${port}`
        }
      }
    }
  </script>
</body>
</html>
