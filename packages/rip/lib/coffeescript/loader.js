// Generated by CoffeeScript 2.9.0

// CoffeeScript ES Module Loader
// Similar to the old register.coffee but for ES modules
// Usage: node --loader coffeescript/lib/coffeescript/loader.js
import { pathToFileURL } from 'url';
import { readFileSync } from 'fs';
import CoffeeScript from './index.js';

// Resolve hook - handles .coffee file imports
export var resolve = function(specifier, context, nextResolve) {
  var url;
  // Handle .coffee file imports
  if (specifier.endsWith('.coffee')) {
    url = new URL(specifier, context.parentURL).href;
    return {
      url,
      format: 'module',
      shortCircuit: true
    };
  }
  // Pass through all other imports
  return nextResolve(specifier, context);
};

// Load hook - compiles .coffee files to ES modules
export var load = function(url, context, nextLoad) {
  var compiled, source;
  // Compile .coffee files to ES modules
  if (url.endsWith('.coffee')) {
    source = readFileSync(new URL(url), 'utf8');
    compiled = CoffeeScript.compile(source, {
      bare: true,
      filename: url
    });
    return {
      format: 'module',
      source: compiled,
      shortCircuit: true
    };
  }
  // Pass through all other files
  return nextLoad(url, context);
};
